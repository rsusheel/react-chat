import React, { useEffect, useRef } from "react";
import { useDispatch, useSelector } from "react-redux";
import "./UserControls.css";
import { toggleLockRoom, toggleMuteSelf, toggleDrawSelf, leaveRoom, leaveRoomUpdateInfo } from "../redux";

function UserControls(props) {
  const data = useSelector((state) => state.personal);
  const uniData = useSelector((state) => state.universal);
  const dispatch = useDispatch();

  const socket = props.socket;

  useEffect(() => {
    if (data.creator) {
      document.getElementsByClassName(
        "user-controls-btn"
      )[0].style.gridTemplateColumns = "1fr 1fr 1fr 1fr";
      document.getElementsByClassName("user-controls-btn")[0].style.width =
        "250px";
    }
  }, [data.creator]);

  const singleEffect = useRef(true);
  useEffect(() => {
    if (singleEffect.current) {
      socket.on("dtoggle_lock_room", () => {
        dispatch(toggleLockRoom());
      });

      socket.on("dleave_room", (info)=>{
        var username=info.username
        dispatch(leaveRoom({username}))
        socket.emit("leave_room_final", info)
      })

      socket.on("dleave_room_final", info=>{
        var exitRoom = info.exitRoom
        dispatch(leaveRoomUpdateInfo({exitRoom}))
        socket.emit("leave_exit_room_end_call", info)
      })
      singleEffect.current = false;
    }
  }, [socket]);

  const lockRoomBtn = (e) => {
    socket.emit("toggle_lock_room", data.room);
  };

  const selfMuteBtn = (e) => {
    dispatch(toggleMuteSelf());
  };

  const selfDrawBtn = (e) => {
    dispatch(toggleDrawSelf());
  };

  const leaveCallBtn = (e) => {
    // dispatch(leaveRoom({username: data.username}))
    socket.emit("leave_room", {room: data.room, username: data.username})
  }

  return (
    <div className="user-controls">
      <div className="user-controls-btn">
        
        {(data.creator ? (data.selfMute) : (uniData.allMute || data.selfMute)) ? (
          <svg
            onClick={selfMuteBtn}
            height="21"
            viewBox="0 0 29 31"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M8.75049 13.9853V16C8.75049 17.4918 9.34312 18.9226 10.398 19.9775C11.4529 21.0324 12.8836 21.625 14.3755 21.625C14.9001 21.625 15.4172 21.5517 15.9131 21.4108L8.75049 13.9853ZM17.3394 22.8895C16.412 23.2885 15.4046 23.5 14.3755 23.5C12.3864 23.5 10.4787 22.7098 9.07219 21.3033C7.66566 19.8968 6.87549 17.9891 6.87549 16V14.125C6.87549 13.8764 6.77672 13.6379 6.6009 13.4621C6.42509 13.2863 6.18663 13.1875 5.93799 13.1875C5.68935 13.1875 5.45089 13.2863 5.27508 13.4621C5.09926 13.6379 5.00049 13.8764 5.00049 14.125V16C5.00046 18.3241 5.86371 20.5654 7.42276 22.289C8.98182 24.0126 11.1255 25.0957 13.438 25.3281V29.125H7.81299C7.56435 29.125 7.32589 29.2238 7.15008 29.3996C6.97426 29.5754 6.87549 29.8139 6.87549 30.0625C6.87549 30.3111 6.97426 30.5496 7.15008 30.7254C7.32589 30.9012 7.56435 31 7.81299 31H20.938C21.1866 31 21.4251 30.9012 21.6009 30.7254C21.7767 30.5496 21.8755 30.3111 21.8755 30.0625C21.8755 29.8139 21.7767 29.5754 21.6009 29.3996C21.4251 29.2238 21.1866 29.125 20.938 29.125H15.313V25.3281C16.5103 25.2078 17.6625 24.8594 18.7116 24.3121L17.3394 22.8895ZM22.6952 20.3214L21.3018 18.8768C21.677 17.9736 21.8755 16.997 21.8755 16V14.125C21.8755 13.8764 21.9743 13.6379 22.1501 13.4621C22.3259 13.2863 22.5643 13.1875 22.813 13.1875C23.0616 13.1875 23.3001 13.2863 23.4759 13.4621C23.6517 13.6379 23.7505 13.8764 23.7505 14.125V16C23.7505 17.5159 23.3833 18.9966 22.6952 20.3214ZM19.8347 17.3558L8.79587 5.91171C8.95293 4.68295 9.51267 3.53287 10.398 2.64752C11.4529 1.59263 12.8836 1 14.3755 1C15.8673 1 17.2981 1.59263 18.353 2.64752C19.4079 3.70242 20.0005 5.13316 20.0005 6.625V16C20.0005 16.4609 19.9439 16.9159 19.8347 17.3558Z"
              fill={uniData.allMute?"rgba(255, 0, 0, 0.63)":"rgba(160, 141, 235, 0.63)"}
            />
            <line
              x1="1.28964"
              y1="1.96892"
              x2="27.7896"
              y2="29.9689"
              stroke={uniData.allMute?"rgba(255, 0, 0, 0.63)":"rgba(160, 141, 235, 0.63)"}
              stroke-width="3"
            />
          </svg>
        ) : (
          <svg
            onClick={selfMuteBtn}
            height="21"
            viewBox="0 0 19 30"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M3.75 5.625C3.75 4.13316 4.34263 2.70242 5.39752 1.64752C6.45242 0.592632 7.88316 0 9.375 0C10.8668 0 12.2976 0.592632 13.3525 1.64752C14.4074 2.70242 15 4.13316 15 5.625V15C15 16.4918 14.4074 17.9226 13.3525 18.9775C12.2976 20.0324 10.8668 20.625 9.375 20.625C7.88316 20.625 6.45242 20.0324 5.39752 18.9775C4.34263 17.9226 3.75 16.4918 3.75 15V5.625Z"
              fill="rgb(160, 141, 235)"
            />
            <path
              d="M0.9375 12.1875C1.18614 12.1875 1.4246 12.2863 1.60041 12.4621C1.77623 12.6379 1.875 12.8764 1.875 13.125V15C1.875 16.9891 2.66518 18.8968 4.0717 20.3033C5.47822 21.7098 7.38588 22.5 9.375 22.5C11.3641 22.5 13.2718 21.7098 14.6783 20.3033C16.0848 18.8968 16.875 16.9891 16.875 15V13.125C16.875 12.8764 16.9738 12.6379 17.1496 12.4621C17.3254 12.2863 17.5639 12.1875 17.8125 12.1875C18.0611 12.1875 18.2996 12.2863 18.4754 12.4621C18.6512 12.6379 18.75 12.8764 18.75 13.125V15C18.75 17.3241 17.8868 19.5654 16.3277 21.289C14.7687 23.0126 12.625 24.0957 10.3125 24.3281V28.125H15.9375C16.1861 28.125 16.4246 28.2238 16.6004 28.3996C16.7762 28.5754 16.875 28.8139 16.875 29.0625C16.875 29.3111 16.7762 29.5496 16.6004 29.7254C16.4246 29.9012 16.1861 30 15.9375 30H2.8125C2.56386 30 2.3254 29.9012 2.14959 29.7254C1.97377 29.5496 1.875 29.3111 1.875 29.0625C1.875 28.8139 1.97377 28.5754 2.14959 28.3996C2.3254 28.2238 2.56386 28.125 2.8125 28.125H8.4375V24.3281C6.12503 24.0957 3.98133 23.0126 2.42227 21.289C0.86322 19.5654 -2.91969e-05 17.3241 7.40637e-10 15V13.125C7.40637e-10 12.8764 0.0987722 12.6379 0.274588 12.4621C0.450403 12.2863 0.68886 12.1875 0.9375 12.1875Z"
              fill="rgb(160, 141, 235)"
            />
          </svg>
        )}

        <svg
        onClick={leaveCallBtn}
          height="31"
          viewBox="0 0 37 37"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M33.8398 20.0293L33.5346 21.628C33.2494 23.125 31.8495 24.1302 30.2647 23.9775L27.1104 23.6723C25.7353 23.5397 24.5636 22.5623 24.2136 21.258L23.2408 17.6274C21.7994 17.037 20.2115 16.7672 18.4771 16.818C16.8068 16.854 15.1607 17.2246 13.6363 17.908L13.0335 21.3074C12.8038 22.5962 11.7416 23.5567 10.3941 23.6923L7.25839 24.0068C5.6936 24.1641 4.19202 23.1682 3.74802 21.6789L3.2701 20.0802C2.79681 18.4892 3.21922 16.815 4.38318 15.6849C7.12735 13.0178 11.7061 11.6797 18.1148 11.6704C24.5328 11.6627 29.2518 12.9932 32.2735 15.6602C33.5454 16.7826 34.1389 18.4445 33.8383 20.0293H33.8398Z"
            fill="red"
          />
        </svg>

        {data.creator ? (
          uniData.locked ? (
            <svg
              onClick={lockRoomBtn}
              height="19"
              viewBox="0 0 14 18"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12.8 7H11V4.6C11 1.703 9.665 0 7 0C4.334 0 3 1.703 3 4.6V7H1C0.447 7 0 7.646 0 8.199V16C0 16.549 0.428 17.139 0.951 17.307L2.148 17.694C2.7829 17.8791 3.43892 17.9819 4.1 18H9.9C10.5608 17.9821 11.2166 17.8789 11.851 17.693L13.047 17.306C13.571 17.139 14 16.549 14 16V8.199C14 7.646 13.352 7 12.8 7ZM9 7H5V4.199C5 2.754 5.797 2 7 2C8.203 2 9 2.754 9 4.199V7Z"
                fill="red"
              />
            </svg>
          ) : (
            <svg
              onClick={lockRoomBtn}
              height="19"
              viewBox="0 0 14 18"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12.8 7H11V4.6C11 1.703 9.665 0 7 0C4.334 0 3 1.703 3 4.6V5H5V4.199C5 2.754 5.797 2 7 2C8.203 2 9 2.754 9 4.199V7H1C0.447 7 0 7.646 0 8.199V16C0 16.549 0.428 17.139 0.951 17.307L2.148 17.694C2.7829 17.8791 3.43892 17.9819 4.1 18H9.9C10.5608 17.9821 11.2166 17.8789 11.851 17.693L13.047 17.306C13.571 17.139 14 16.549 14 16V8.199C14 7.646 13.352 7 12.8 7Z"
                fill="rgb(160, 141, 235)"
              />
            </svg>
          )
        ) : (
          <></>
        )}

        
        {(data.creator ? data.drawEnabled : (uniData.drawEnabled && data.drawEnabled)) ? (
          <svg
            onClick={selfDrawBtn}
            height="21"
            viewBox="0 0 30 30"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M23.4375 13.1701L11.5826 25.0199L9.85921 23.2966L10.0371 23.1187H7.69361C7.24625 23.1187 6.88023 22.7527 6.88023 22.3053V19.9618L6.70281 20.1397C6.46236 20.3837 6.28596 20.6786 6.18988 21.0039L5.02167 24.9793L8.995 23.81C9.2746 23.7135 9.6152 23.5355 9.85921 23.2966L11.5826 25.0199C11.0539 25.5486 10.3981 25.9401 9.68129 26.1485L3.56421 27.9481C3.13617 28.0752 2.67305 27.9583 2.35736 27.5973C2.04167 27.3279 1.92363 26.8653 2.0496 26.4332L3.84889 20.3176C4.06037 19.6008 4.44824 18.945 4.97744 18.4164L16.8288 6.56346L23.4375 13.1701ZM27.0468 4.95756C28.3177 6.22794 28.3177 8.28985 27.0468 9.56074L24.5864 12.0212L17.9777 5.41355L20.4382 2.9531C21.7091 1.6823 23.773 1.6823 25.0439 2.9531L27.0468 4.95756V4.95756Z"
              fill="rgb(160, 141, 235)"
            />
          </svg>
        ) : (
          <svg
            onClick={selfDrawBtn}
            height="20.7"
            viewBox="0 0 26 27"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M7.52799 12.8652L2.97744 17.4164C2.44824 17.945 2.06037 18.6008 1.84889 19.3176L0.0496027 25.4332C-0.0763686 25.8653 0.0416723 26.3279 0.357363 26.5973C0.673054 26.9583 1.13617 27.0752 1.56421 26.9481L7.68129 25.1485C8.39808 24.9401 9.05386 24.5486 9.58255 24.0199L14.0145 19.5899L7.52799 12.8652ZM18.0025 15.6036L21.4375 12.1701L14.8288 5.56346L11.5148 8.87785L18.0025 15.6036ZM8.03714 22.1187L7.85921 22.2966C7.6152 22.5355 7.2746 22.7135 6.995 22.81L3.02167 23.9793L4.18988 20.0039C4.28596 19.6786 4.46236 19.3837 4.70281 19.1397L4.88023 18.9618V21.3053C4.88023 21.7527 5.24625 22.1187 5.69361 22.1187H8.03714ZM25.0468 8.56074C26.3177 7.28985 26.3177 5.22794 25.0468 3.95756L23.0439 1.9531C21.773 0.682301 19.7091 0.682301 18.4382 1.9531L15.9777 4.41355L22.5864 11.0212L25.0468 8.56074Z"
              fill={uniData.drawEnabled?"rgba(160, 141, 235, 0.63)":"rgba(255, 0, 0, 0.63)"}
            />
            <line
              x1="1.08298"
              y1="1.96214"
              x2="24.083"
              y2="25.9621"
              stroke={uniData.drawEnabled?"rgba(160, 141, 235, 0.63)":"rgba(255, 0, 0, 0.63)"}
              stroke-width="3"
            />
          </svg>
        )}
      </div>
    </div>
  );
}

export default UserControls;
